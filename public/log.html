<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbitmate Server Logs</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: #1a1a1a;
            color: #e0e0e0;
            line-height: 1.4;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #2d2d2d;
            padding: 10px 20px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .header h1 {
            color: #00ff00;
            font-size: 18px;
            font-weight: bold;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .filter-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.2s ease;
            color: white;
            background: #444;
        }

        .filter-btn.active {
            box-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        .filter-btn.level-INFO { border: 1px solid #4CAF50; }
        .filter-btn.level-INFO.active { background: #4CAF50; }

        .filter-btn.level-WARN { border: 1px solid #FF9800; }
        .filter-btn.level-WARN.active { background: #FF9800; }

        .filter-btn.level-ERROR { border: 1px solid #F44336; }
        .filter-btn.level-ERROR.active { background: #F44336; }

        .filter-btn.level-API { border: 1px solid #9C27B0; }
        .filter-btn.level-API.active { background: #9C27B0; }

        .filter-btn.level-REQUEST { border: 1px solid #607D8B; }
        .filter-btn.level-REQUEST.active { background: #607D8B; }

        .filter-btn.level-RESPONSE { border: 1px solid #795548; }
        .filter-btn.level-RESPONSE.active { background: #795548; }

        .filter-btn.level-SYSTEM { border: 1px solid #607D8B; }
        .filter-btn.level-SYSTEM.active { background: #607D8B; }

        .auto-scroll-toggle {
            padding: 5px 10px;
            border: 1px solid #666;
            border-radius: 4px;
            background: #333;
            color: white;
            cursor: pointer;
            font-size: 12px;
        }

        .auto-scroll-toggle.active {
            background: #00ff00;
            color: #000;
        }

        .search-box {
            padding: 5px 8px;
            border: 1px solid #666;
            border-radius: 4px;
            background: #333;
            color: white;
            font-size: 12px;
            width: 200px;
        }

        .clear-btn {
            padding: 5px 10px;
            border: 1px solid #666;
            border-radius: 4px;
            background: #555;
            color: white;
            cursor: pointer;
            font-size: 12px;
        }

        .clear-btn:hover {
            background: #666;
        }

        .log-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: #1a1a1a;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 4px;
            border-left: 4px solid;
            font-size: 13px;
            word-wrap: break-word;
            transition: all 0.2s ease;
        }

        .log-entry:hover {
            background: rgba(255,255,255,0.05);
        }

        .log-entry.level-INFO {
            border-left-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .log-entry.level-WARN {
            border-left-color: #FF9800;
            background: rgba(255, 152, 0, 0.1);
        }

        .log-entry.level-ERROR {
            border-left-color: #F44336;
            background: rgba(244, 67, 54, 0.1);
        }

        .log-entry.level-API {
            border-left-color: #9C27B0;
            background: rgba(156, 39, 176, 0.1);
        }

        .log-entry.level-REQUEST {
            border-left-color: #2196F3;
            background: rgba(33, 150, 243, 0.1);
        }

        .log-entry.level-RESPONSE {
            border-left-color: #9C27B0;
            background: rgba(156, 39, 176, 0.1);
        }

        .log-entry.level-SYSTEM {
            border-left-color: #607D8B;
            background: rgba(96, 125, 139, 0.1);
        }

        .log-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .timestamp {
            color: #888;
            font-size: 11px;
        }

        .level-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }

        .level-badge.INFO { background: #4CAF50; color: white; }
        .level-badge.WARN { background: #FF9800; color: white; }
        .level-badge.ERROR { background: #F44336; color: white; }
        .level-badge.API { background: #9C27B0; color: white; }
        .level-badge.REQUEST { background: #607D8B; color: white; }
        .level-badge.RESPONSE { background: #795548; color: white; }
        .level-badge.SYSTEM { background: #2196F3; color: white; }

        .request-id {
            background: #333;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            color: #ccc;
        }

        .method {
            font-weight: bold;
            color: #00ff00;
        }

        .url {
            color: #87CEEB;
        }

        .status {
            font-weight: bold;
        }

        .status.success { color: #4CAF50; }
        .status.client-error { color: #FF9800; }
        .status.server-error { color: #F44336; }

        .duration {
            color: #FFD700;
            font-size: 11px;
        }

        .message {
            color: #e0e0e0;
            margin-top: 5px;
        }

        .stack-trace {
            margin-top: 5px;
            padding: 8px;
            background: rgba(244, 67, 54, 0.2);
            border-radius: 4px;
            font-size: 11px;
            line-height: 1.3;
        }

        .stack-line {
            margin: 2px 0;
            color: #ffcccb;
        }

        .body-content {
            margin-top: 5px;
            padding: 5px;
            background: rgba(255,255,255,0.05);
            border-radius: 3px;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
        }

        .hidden {
            display: none;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #F44336;
        }

        .status-dot.connected {
            background: #4CAF50;
        }

        .stats {
            font-size: 11px;
            color: #888;
        }

        /* Ïä§ÌÅ¨Î°§Î∞î Ïä§ÌÉÄÏùºÎßÅ */
        .log-container::-webkit-scrollbar {
            width: 8px;
        }

        .log-container::-webkit-scrollbar-track {
            background: #2d2d2d;
        }

        .log-container::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

        .log-container::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Orbitmate Server Logs</h1>
            <div class="controls">
                <div class="filter-group">
                    <button class="filter-btn level-INFO active" data-level="INFO">INFO</button>
                    <button class="filter-btn level-WARN active" data-level="WARN">WARN</button>
                    <button class="filter-btn level-ERROR active" data-level="ERROR">ERROR</button>
                    <button class="filter-btn level-API active" data-level="API">API</button>
                    <button class="filter-btn level-REQUEST" data-level="REQUEST">REQ</button>
                    <button class="filter-btn level-RESPONSE" data-level="RESPONSE">RES</button>
                    <button class="filter-btn level-SYSTEM active" data-level="SYSTEM">SYS</button>
                </div>
                <input type="text" class="search-box" placeholder="Í≤ÄÏÉâ..." id="search-input">
                <button class="auto-scroll-toggle active" id="auto-scroll-toggle">ÏûêÎèôÏä§ÌÅ¨Î°§</button>
                <button class="clear-btn" id="clear-logs">ÏßÄÏö∞Í∏∞</button>
                <div class="connection-status">
                    <div class="status-dot" id="connection-dot"></div>
                    <span id="connection-text">Ïó∞Í≤∞ Ï§ë...</span>
                </div>
                <div class="stats" id="log-stats">Î°úÍ∑∏: 0</div>
            </div>
        </div>
        <div class="log-container" id="log-container">
            <!-- Î°úÍ∑∏ ÏóîÌä∏Î¶¨Îì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
        </div>
    </div>

    <script>
        class LogViewer {
            constructor() {
                this.logs = [];
                this.filteredLogs = [];
                this.activeFilters = new Set(['INFO', 'WARN', 'ERROR', 'API', 'SYSTEM']);
                this.autoScroll = true;
                this.searchTerm = '';
                this.eventSource = null;
                this.logContainer = document.getElementById('log-container');
                this.connectionDot = document.getElementById('connection-dot');
                this.connectionText = document.getElementById('connection-text');
                this.logStats = document.getElementById('log-stats');
                
                this.initializeEventListeners();
                this.connectToLogStream();
                this.loadRecentLogs();
            }

            initializeEventListeners() {
                // ÌïÑÌÑ∞ Î≤ÑÌäºÎì§
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const level = btn.dataset.level;
                        this.toggleFilter(level, btn);
                    });
                });

                // ÏûêÎèô Ïä§ÌÅ¨Î°§ ÌÜ†Í∏Ä
                document.getElementById('auto-scroll-toggle').addEventListener('click', (e) => {
                    this.autoScroll = !this.autoScroll;
                    e.target.classList.toggle('active', this.autoScroll);
                });

                // Í≤ÄÏÉâ
                document.getElementById('search-input').addEventListener('input', (e) => {
                    this.searchTerm = e.target.value.toLowerCase();
                    this.applyFilters();
                });

                // Î°úÍ∑∏ ÏßÄÏö∞Í∏∞
                document.getElementById('clear-logs').addEventListener('click', () => {
                    this.clearLogs();
                });
            }

            toggleFilter(level, btnElement) {
                if (this.activeFilters.has(level)) {
                    this.activeFilters.delete(level);
                    btnElement.classList.remove('active');
                } else {
                    this.activeFilters.add(level);
                    btnElement.classList.add('active');
                }
                this.applyFilters();
            }

            applyFilters() {
                this.filteredLogs = this.logs.filter(log => {
                    const levelMatch = this.activeFilters.has(log.level);
                    const searchMatch = this.searchTerm === '' || 
                        JSON.stringify(log).toLowerCase().includes(this.searchTerm);
                    return levelMatch && searchMatch;
                });
                this.renderLogs();
                this.updateStats();
            }

            connectToLogStream() {
                this.eventSource = new EventSource('/api/logs/stream/live');
                
                this.eventSource.onopen = () => {
                    this.connectionDot.classList.add('connected');
                    this.connectionText.textContent = 'Ïã§ÏãúÍ∞Ñ Ïó∞Í≤∞Îê®';
                };

                this.eventSource.onmessage = (event) => {
                    try {
                        const logData = JSON.parse(event.data);
                        if (logData.type === 'connected') return;
                        
                        this.addLog(logData);
                    } catch (error) {
                        console.error('Î°úÍ∑∏ ÌååÏã± ÏóêÎü¨:', error);
                    }
                };

                this.eventSource.onerror = () => {
                    this.connectionDot.classList.remove('connected');
                    this.connectionText.textContent = 'Ïó∞Í≤∞ ÎÅäÍπÄ';
                    
                    // Ïû¨Ïó∞Í≤∞ ÏãúÎèÑ
                    setTimeout(() => {
                        this.connectToLogStream();
                    }, 3000);
                };
            }

            async loadRecentLogs() {
                try {
                    const response = await fetch('/api/logs/recent?lines=100');
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        this.logs = result.data.logs || [];
                        this.applyFilters();
                    }
                } catch (error) {
                    console.error('ÏµúÍ∑º Î°úÍ∑∏ Î°úÎìú ÏóêÎü¨:', error);
                }
            }

            addLog(logData) {
                const parsedLog = this.parseLogData(logData);
                this.logs.push(parsedLog);
                
                // ÏµúÎåÄ 1000Í∞ú Î°úÍ∑∏Îßå Ïú†ÏßÄ
                if (this.logs.length > 1000) {
                    this.logs.shift();
                }
                
                this.applyFilters();
                
                if (this.autoScroll) {
                    setTimeout(() => {
                        this.logContainer.scrollTop = this.logContainer.scrollHeight;
                    }, 10);
                }
            }

            parseLogData(data) {
                // ÏÉàÎ°úÏö¥ Íµ¨Ï°∞ÌôîÎêú Î°úÍ∑∏ ÌòïÏãù ÌååÏã±
                return {
                    timestamp: data.timestamp || new Date().toISOString(),
                    level: data.level || data.type || 'INFO',
                    requestId: data.requestId,
                    method: data.method,
                    url: data.url,
                    status: data.status,
                    duration: data.duration,
                    code: data.code,
                    message: data.message,
                    stack: data.stack,
                    body: data.body,
                    requestBody: data.requestBody,
                    responseBody: data.responseBody,  // ÏÉàÎ°úÏö¥ ÌÜµÌï© API Î°úÍ∑∏ ÏßÄÏõê
                    ip: data.ip,
                    contentType: data.contentType,
                    query: data.query,
                    params: data.params,
                    meta: data.meta,
                    raw: data.raw
                };
            }

            renderLogs() {
                this.logContainer.innerHTML = this.filteredLogs.map(log => this.renderLogEntry(log)).join('');
            }

            renderLogEntry(log) {
                const timestamp = new Date(log.timestamp).toLocaleTimeString('ko-KR', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit',
                    fractionalSecondDigits: 3
                });

                let statusClass = '';
                if (log.status) {
                    const status = parseInt(log.status);
                    if (status >= 200 && status < 300) statusClass = 'success';
                    else if (status >= 400 && status < 500) statusClass = 'client-error';
                    else if (status >= 500) statusClass = 'server-error';
                }

                let content = '';
                
                // Î°úÍ∑∏ Ìó§Îçî
                content += `<div class="log-header">`;
                content += `<span class="timestamp">${timestamp}</span>`;
                content += `<span class="level-badge ${log.level}">${log.level}</span>`;
                
                if (log.requestId) {
                    content += `<span class="request-id">${log.requestId}</span>`;
                }
                
                if (log.method) {
                    content += `<span class="method">${log.method}</span>`;
                }
                
                if (log.url) {
                    content += `<span class="url">${log.url}</span>`;
                }
                
                if (log.status) {
                    content += `<span class="status ${statusClass}">${log.status}</span>`;
                }
                
                if (log.duration) {
                    content += `<span class="duration">${log.duration}ms</span>`;
                }
                
                if (log.code) {
                    content += `<span class="code">${log.code}</span>`;
                }
                
                content += `</div>`;

                // Î©îÏãúÏßÄ
                if (log.message) {
                    content += `<div class="message">${this.escapeHtml(log.message)}</div>`;
                }

                // Ïä§ÌÉù Ìä∏Î†àÏù¥Ïä§
                if (log.stack && log.stack.length > 0) {
                    content += `<div class="stack-trace">`;
                    log.stack.forEach((line, index) => {
                        content += `<div class="stack-line">${index + 1}. ${this.escapeHtml(line)}</div>`;
                    });
                    content += `</div>`;
                }

                // ÌÜµÌï© API Î°úÍ∑∏Ïùò ÏöîÏ≤≠/ÏùëÎãµ Î∞îÎîî ÌëúÏãú (Îçî ÏÉÅÏÑ∏ÌïòÍ≤å)
                if (log.level === 'API') {
                    // ÏöîÏ≤≠ Î∞îÎîî
                    if (log.requestBody) {
                        content += `<div class="body-content">`;
                        content += `<strong>üì§ Request Body:</strong><br>`;
                        content += `<pre>${this.escapeHtml(JSON.stringify(log.requestBody, null, 2))}</pre>`;
                        content += `</div>`;
                    }
                    
                    // ÏùëÎãµ Î∞îÎîî
                    if (log.responseBody) {
                        content += `<div class="body-content">`;
                        content += `<strong>üì• Response Body:</strong><br>`;
                        content += `<pre>${this.escapeHtml(JSON.stringify(log.responseBody, null, 2))}</pre>`;
                        content += `</div>`;
                    }
                    
                    // IP Îì± Ï∂îÍ∞Ä Ï†ïÎ≥¥
                    if (log.ip && log.ip !== 'unknown') {
                        content += `<div class="body-content">`;
                        content += `<strong>üåê IP:</strong> ${this.escapeHtml(log.ip)}<br>`;
                        if (log.contentType && log.contentType !== 'none') {
                            content += `<strong>üìÑ Content Type:</strong> ${this.escapeHtml(log.contentType)}<br>`;
                        }
                        content += `</div>`;
                    }
                } else {
                    // Í∏∞Ï°¥ Î°úÍ∑∏ ÌòïÏãù (Ìò∏ÌôòÏÑ±)
                    if (log.body) {
                        content += `<div class="body-content">`;
                        content += `<strong>üìÑ Data:</strong><br>`;
                        content += `<pre>${this.escapeHtml(JSON.stringify(log.body, null, 2))}</pre>`;
                        content += `</div>`;
                    }
                }

                // Raw Îç∞Ïù¥ÌÑ∞ (fallback)
                if (log.raw) {
                    content += `<div class="message">${this.escapeHtml(log.raw)}</div>`;
                }

                return `<div class="log-entry level-${log.level}">${content}</div>`;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            clearLogs() {
                this.logs = [];
                this.filteredLogs = [];
                this.renderLogs();
                this.updateStats();
            }

            updateStats() {
                this.logStats.textContent = `Î°úÍ∑∏: ${this.filteredLogs.length}/${this.logs.length}`;
            }
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Î°úÍ∑∏ Î∑∞Ïñ¥ Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', () => {
            new LogViewer();
        });
    </script>
</body>
</html>
